{% extends 'core/base.html' %}
{% load static widget_tweaks %}
{% block title %}ثبت هزینه‌ها{% endblock %}
{% block content %}
    <!-- بقیه کد تا قبل از فرم همونه -->
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="costForm">
        {% csrf_token %}

        <!-- قیمت روز -->
        <div class="mb-4">
            <label class="form-label fw-bold text-muted d-block text-end">{{ form.daily_price.label }}</label>
            {{ form.daily_price|add_class:"form-control small-input" }}
            {% if form.daily_price.errors %}
                <div class="text-danger mt-1 text-end">{{ form.daily_price.errors }}</div>
            {% endif %}
        </div>

        <!-- بخش‌های اسناد و هزینه‌ها -->
        <div class="row g-4">
            <!-- ستون اسناد -->
            <div class="col-md-6">
                <h4 class="mb-3 text-muted fw-bold text-center">اسناد</h4>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.fine_document.label }}</label>
                        <input type="file" name="fine_document" id="id_fine_document" class="form-control modern-input d-none" accept="image/*">
                        <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="captureImage('id_fine_document', 'fine_preview')">گرفتن عکس</button>
                        <img id="fine_preview" class="img-preview mt-2" style="display:none; max-width: 100%;">
                        {% if form.fine_document.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.fine_document.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.court_document.label }}</label>
                        <input type="file" name="court_document" id="id_court_document" class="form-control modern-input d-none" accept="image/*">
                        <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="captureImage('id_court_document', 'court_preview')">گرفتن عکس</button>
                        <img id="court_preview" class="img-preview mt-2" style="display:none; max-width: 100%;">
                        {% if form.court_document.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.court_document.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.transport_document.label }}</label>
                        <input type="file" name="transport_document" id="id_transport_document" class="form-control modern-input d-none" accept="image/*">
                        <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="captureImage('id_transport_document', 'transport_preview')">گرفتن عکس</button>
                        <img id="transport_preview" class="img-preview mt-2" style="display:none; max-width: 100%;">
                        {% if form.transport_document.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.transport_document.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.proxy_document.label }}</label>
                        <input type="file" name="proxy_document" id="id_proxy_document" class="form-control modern-input d-none" accept="image/*">
                        <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="captureImage('id_proxy_document', 'proxy_preview')">گرفتن عکس</button>
                        <img id="proxy_preview" class="img-preview mt-2" style="display:none; max-width: 100%;">
                        {% if form.proxy_document.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.proxy_document.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ستون هزینه‌ها -->
            <div class="col-md-6">
                <h4 class="mb-3 text-muted fw-bold text-center">هزینه‌ها</h4>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.fine.label }}</label>
                        {{ form.fine|add_class:"form-control modern-input" }}
                        {% if form.fine.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.fine.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.court_cost.label }}</label>
                        {{ form.court_cost|add_class:"form-control modern-input" }}
                        {% if form.court_cost.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.court_cost.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.transport_cost.label }}</label>
                        {{ form.transport_cost|add_class:"form-control modern-input" }}
                        {% if form.transport_cost.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.transport_cost.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-muted d-block text-end">{{ form.proxy_cost.label }}</label>
                        {{ form.proxy_cost|add_class:"form-control modern-input" }}
                        {% if form.proxy_cost.errors %}
                            <div class="text-danger mt-1 text-end">{{ form.proxy_cost.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌ها -->
        <div class="d-flex justify-content-center gap-3 mt-5">
            <button type="submit" class="btn btn-primary modern-btn px-4 py-2">ذخیره</button>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary modern-btn px-4 py-2">بازگشت</a>
        </div>
    </form>

    <!-- بقیه کد (استایل‌ها و انیمیشن‌ها) همونه -->

    <!-- اسکریپت جدید -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // تابع گرفتن عکس و فشرده‌سازی
            window.captureImage = function (inputId, previewId) {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);

                // دسترسی به وب‌کم
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.play();

                        // نمایش ویدیو موقت
                        const modal = document.createElement('div');
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100%';
                        modal.style.height = '100%';
                        modal.style.background = 'rgba(0,0,0,0.8)';
                        modal.style.display = 'flex';
                        modal.style.justifyContent = 'center';
                        modal.style.alignItems = 'center';
                        modal.style.zIndex = '1000';

                        video.style.maxWidth = '90%';
                        video.style.maxHeight = '90%';

                        const captureBtn = document.createElement('button');
                        captureBtn.innerText = 'عکس بگیر';
                        captureBtn.className = 'btn btn-primary mt-3';
                        captureBtn.onclick = function () {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0);

                            // فشرده‌سازی
                            canvas.toBlob(function (blob) {
                                const compressedFile = new File([blob], 'photo.jpg', {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });

                                console.log('حجم فشرده:', compressedFile.size / 1024, 'KB');

                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(compressedFile);
                                input.files = dataTransfer.files;

                                preview.src = URL.createObjectURL(compressedFile);
                                preview.style.display = 'block';

                                // بستن ویدیو و مدال
                                stream.getTracks().forEach(track => track.stop());
                                document.body.removeChild(modal);
                            }, 'image/jpeg', 0.7); // کیفیت 70%
                        };

                        modal.appendChild(video);
                        modal.appendChild(captureBtn);
                        document.body.appendChild(modal);
                    })
                    .catch(err => {
                        console.error('خطا در دسترسی به دوربین:', err);
                        alert('نمی‌تونم به دوربین دسترسی پیدا کنم. لطفاً دسترسی رو چک کن یا فایل آپلود کن.');
                    });
            };

            // اعتبارسنجی فرم
            const form = document.getElementById('costForm');
            form.addEventListener('submit', function (event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        });
    </script>
{% endblock %}